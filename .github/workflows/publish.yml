name: Publish

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*" # publish when you push a semver tag like v1.2.3

concurrency:
  group: npm-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # optional (for npm provenance if you enable it)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node + npm auth
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Configure npm auth + registry (for npm CLI)
        run: |
          mkdir -p ~/.npm
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          npm config set registry https://registry.npmjs.org/
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - name: Install deps
        run: yarn install --immutable

      - name: Build
        run: yarn build
        env:
          CI: "true"

      - name: Publish workspaces (npm publish via yarn foreach)
        run: |
          yarn workspaces foreach \
            -A \
            -t \
            --topological \
            --no-private \
            --verbose \
            sh -lc '
              NAME=$(node -p "require(\"./package.json\").name")
              VER=$(node -p "require(\"./package.json\").version")

              # Ensure we publish to npm, not Yarn registry
              npm config set registry https://registry.npmjs.org/ >/dev/null

              # Skip if that exact version already exists
              if npm view "${NAME}@${VER}" version >/dev/null 2>&1; then
                echo "Skipping ${NAME}@${VER} (already published)"
                exit 0
              fi

              npm publish
            '
        env:
          # npm uses ~/.npmrc, but keeping this helps some setups
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
